<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard - AdventureWorks AI</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Smooth scrolling for table */
        .custom-scrollbar::-webkit-scrollbar {
            height: 6px;
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="bg-white/80 backdrop-blur-md shadow-sm border-b border-slate-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                
                <!-- Left Side: Logo & Navigation -->
                <div class="flex items-center gap-6">
                    <!-- Brand -->
                    <div class="flex items-center gap-3">
                        <div class="bg-gradient-to-br from-indigo-600 to-violet-600 text-white p-1.5 rounded-lg shadow-md shadow-indigo-500/30">
                            <i class="fa-solid fa-chart-pie text-sm"></i>
                        </div>
                        <span class="font-bold text-lg tracking-tight text-slate-900">AdventureWorks <span class="text-indigo-600">Analytics</span></span>
                    </div>

                    <!-- Divider -->
                    <div class="h-6 w-px bg-slate-200 hidden sm:block"></div>

                    <!-- Navigation Link -->
                    <a href="/main_page" class="group flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-semibold text-slate-500 hover:text-indigo-600 hover:bg-indigo-50 transition-all">
                        <i class="fa-solid fa-boxes-stacked group-hover:scale-110 transition-transform"></i>
                        Inventory Analysis
                    </a>
                        
                    <a href="/impact_metrics" class="group flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-semibold text-slate-500 hover:text-indigo-600 hover:bg-indigo-50 transition-all">
                        <i class="fa-solid fa-chart-line group-hover:scale-110 transition-transform"></i>
                        Business Impact
                    </a>
            


                </div>

                <!-- Right Side: Notifications -->
                <div class="flex items-center gap-4">
                    
                    <!-- Notification Bell System -->
                    <div class="relative">
                        <button id="notify-btn" class="relative p-2.5 text-slate-500 hover:text-indigo-600 hover:bg-white border border-transparent hover:border-slate-100 hover:shadow-sm rounded-full transition-all duration-200 focus:outline-none">
                            <i class="fa-regular fa-bell text-xl"></i>
                            
                            <!-- Red Dot Badge -->
                            <span class="absolute top-2 right-2.5 h-2.5 w-2.5 bg-rose-500 border-2 border-white rounded-full">
                                <span class="absolute inline-flex h-full w-full rounded-full bg-rose-400 opacity-75 animate-ping"></span>
                            </span>
                        </button>

                        <!-- Notification Dropdown -->
                        <div id="notify-dropdown" class="hidden absolute right-0 mt-4 w-80 bg-white rounded-2xl shadow-[0_20px_60px_-15px_rgba(0,0,0,0.1)] border border-slate-100 overflow-hidden z-50 origin-top-right transform transition-all ring-1 ring-slate-900/5">
                            <div class="px-5 py-4 border-b border-slate-50 bg-slate-50/50 flex justify-between items-center">
                                <span class="text-xs font-bold text-slate-500 uppercase tracking-widest">Notifications</span>
                                <span class="text-[10px] font-bold bg-rose-100 text-rose-600 px-2 py-0.5 rounded-full border border-rose-200">1 New</span>
                            </div>

                            <div onclick="window.location.href='/orders_page'" class="p-5 hover:bg-indigo-50/60 transition-colors cursor-pointer group">
                                <div class="flex items-start gap-4">
                                    <div class="flex-shrink-0 mt-1">
                                        <div class="h-9 w-9 rounded-full bg-amber-100 flex items-center justify-center text-amber-600 shadow-sm border border-amber-200 group-hover:scale-110 transition-transform">
                                            <i class="fa-solid fa-triangle-exclamation text-xs"></i>
                                        </div>
                                    </div>
                                    <div>
                                        <p class="text-sm font-bold text-slate-800 leading-tight group-hover:text-indigo-700 transition-colors">High Demand Alert</p>
                                        <p class="text-xs text-slate-500 mt-1.5 leading-relaxed">
                                            Busier weeks are coming ahead, please adjust your staff schedule.
                                        </p>
                                        <span class="inline-flex items-center mt-2.5 text-[10px] font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded-md group-hover:bg-indigo-100">
                                            Review Schedule &rarr;
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 w-full space-y-10">
        
        <!-- Section 1: Overview KPIs -->
        <div>
            <h2 class="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2">
                <i class="fa-solid fa-sliders text-slate-400 text-sm"></i> Performance Overview
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
                <!-- Orders KPI -->
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 relative overflow-hidden group hover:shadow-lg transition-all duration-300 hover:-translate-y-1">
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 to-cyan-500"></div>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Total Orders</p>
                    <div class="flex items-baseline gap-2 mt-2 mb-4">
                        <h3 class="text-3xl font-extrabold text-slate-800" id="totalOrders">...</h3>
                    </div>
                    <!-- Sparkline Container -->
                    <div class="h-12 w-full">
                        <canvas id="ordersSparkline"></canvas>
                    </div>
                    <div class="mt-4 flex justify-between items-center border-t border-slate-50 pt-3">
                        <span class="text-xs text-slate-400">vs prev. period</span>
                        <span id="ordersChange" class="text-xs font-bold px-2 py-1 rounded-full bg-slate-100 text-slate-600">--</span>
                    </div>
                </div>

                <!-- Units KPI -->
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 relative overflow-hidden group hover:shadow-lg transition-all duration-300 hover:-translate-y-1">
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-emerald-500 to-teal-500"></div>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Units Sold</p>
                    <div class="flex items-baseline gap-2 mt-2 mb-4">
                        <h3 class="text-3xl font-extrabold text-slate-800" id="totalUnits">...</h3>
                    </div>
                    <div class="h-12 w-full">
                        <canvas id="unitsSparkline"></canvas>
                    </div>
                    <div class="mt-4 flex justify-between items-center border-t border-slate-50 pt-3">
                        <span class="text-xs text-slate-400">vs prev. period</span>
                        <span id="unitsChange" class="text-xs font-bold px-2 py-1 rounded-full bg-slate-100 text-slate-600">--</span>
                    </div>
                </div>

                <!-- Customers KPI -->
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 relative overflow-hidden group hover:shadow-lg transition-all duration-300 hover:-translate-y-1">
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-amber-500 to-orange-500"></div>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Active Customers</p>
                    <div class="flex items-baseline gap-2 mt-2 mb-4">
                        <h3 class="text-3xl font-extrabold text-slate-800" id="uniqueCustomers">...</h3>
                    </div>
                    <div class="h-12 w-full">
                        <canvas id="customersSparkline"></canvas>
                    </div>
                    <div class="mt-4 flex justify-between items-center border-t border-slate-50 pt-3">
                        <span class="text-xs text-slate-400">vs prev. period</span>
                        <span id="customersChange" class="text-xs font-bold px-2 py-1 rounded-full bg-slate-100 text-slate-600">--</span>
                    </div>
                </div>

                <!-- Avg Order KPI -->
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 relative overflow-hidden group hover:shadow-lg transition-all duration-300 hover:-translate-y-1">
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-violet-500 to-purple-500"></div>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Avg Order Size</p>
                    <div class="flex items-baseline gap-2 mt-2 mb-4">
                        <h3 class="text-3xl font-extrabold text-slate-800" id="avgOrderSize">...</h3>
                        <span class="text-sm font-medium text-slate-400">units/order</span>
                    </div>
                    <div class="h-12 w-full">
                        <canvas id="avgSparkline"></canvas>
                    </div>
                    <div class="mt-4 flex justify-between items-center border-t border-slate-50 pt-3">
                        <span class="text-xs text-slate-400">Efficiency</span>
                        <span class="text-xs font-bold px-2 py-1 rounded-full bg-emerald-50 text-emerald-600"><i class="fa-solid fa-arrow-trend-up mr-1"></i>Healthy</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 2: Charts Grid -->
        <div>
            <h2 class="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2">
                <i class="fa-solid fa-chart-area text-slate-400 text-sm"></i> Deep Dive Metrics
            </h2>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Sales Trend -->
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 flex flex-col">
                    <h3 class="text-sm font-bold text-slate-700 mb-6">üìà Sales Trend Analysis</h3>
                    <div class="flex-grow relative min-h-[250px]">
                        <canvas id="salesTrendChart"></canvas>
                    </div>
                </div>

                <!-- Category Breakdown -->
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 flex flex-col">
                    <h3 class="text-sm font-bold text-slate-700 mb-6">üì¶ Category Distribution</h3>
                    <div class="flex-grow relative min-h-[250px]">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>

                <!-- Territory Pie Chart -->
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 flex flex-col">
                    <h3 class="text-sm font-bold text-slate-700 mb-6">üó∫Ô∏è Sales by Country</h3>
                    <div class="flex-grow relative min-h-[250px]">
                        <canvas id="territoryChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 3: Top Products Table -->
        <div>
            <h2 class="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2">
                <i class="fa-solid fa-trophy text-slate-400 text-sm"></i> Top Performers
            </h2>

            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                <div class="overflow-x-auto custom-scrollbar">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-slate-50 border-b border-slate-200 text-xs uppercase tracking-wider text-slate-500 font-bold">
                                <th class="p-4 w-16 text-center">Rank</th>
                                <th class="p-4">Product Name</th>
                                <th class="p-4">Category</th>
                                <th class="p-4 text-right">Units Sold</th>
                                <th class="p-4 text-right">Total Orders</th>
                            </tr>
                        </thead>
                        <tbody id="topProductsTable" class="text-sm text-slate-700 divide-y divide-slate-100">
                            <tr><td colspan="5" class="p-8 text-center text-slate-400 italic">Loading data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-slate-200 mt-12">
        <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
            <p class="text-center text-xs text-slate-400">&copy; 2025 AdventureWorks Inc. Analytics Module.</p>
        </div>
    </footer>

    <!-- LOGIC -->
    <script>
        // --- Notification Toggle Logic ---
        const notifyBtn = document.getElementById('notify-btn');
        const notifyDropdown = document.getElementById('notify-dropdown');

        notifyBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            notifyDropdown.classList.toggle('hidden');
        });

        document.addEventListener('click', (e) => {
            if (!notifyBtn.contains(e.target) && !notifyDropdown.contains(e.target)) {
                notifyDropdown.classList.add('hidden');
            }
        });
        // ----------------------------------

        let salesChart = null;
        let categoryChart = null;
        let territoryChart = null;

        // Common Chart Options for Clean UI
        Chart.defaults.font.family = "'Inter', sans-serif";
        Chart.defaults.color = '#64748b';
        Chart.defaults.scale.grid.color = '#f1f5f9';

        function createSparkline(canvasId, data, colorHex) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;
            
            // Convert Hex to RGBA for fill
            const hexToRgba = (hex, alpha) => {
                const r = parseInt(hex.slice(1, 3), 16);
                const g = parseInt(hex.slice(3, 5), 16);
                const b = parseInt(hex.slice(5, 7), 16);
                return `rgba(${r}, ${g}, ${b}, ${alpha})`;
            };

            new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: data.map((_, i) => i),
                    datasets: [{
                        data: data,
                        borderColor: colorHex,
                        backgroundColor: hexToRgba(colorHex, 0.1),
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                    scales: { x: { display: false }, y: { display: false } },
                    interaction: { mode: null },
                    animation: { duration: 1000 }
                }
            });
        }

        document.addEventListener('DOMContentLoaded', async function() {
            await loadOverviewStats();
            await loadSalesTrend();
            await loadTopProducts();
            await loadCategoryBreakdown();
            await loadTerritories();
        });

        // 1. Overview Stats
        async function loadOverviewStats() {
            try {
                const response = await fetch('/api/analytics/overview');
                const data = await response.json();
                const current = data.current_period;
                const changes = data.changes;
                
                document.getElementById('totalOrders').textContent = current.total_orders.toLocaleString();
                document.getElementById('totalUnits').textContent = current.total_units.toLocaleString();
                document.getElementById('uniqueCustomers').textContent = current.unique_customers.toLocaleString();
                document.getElementById('avgOrderSize').textContent = (current.total_units / current.total_orders).toFixed(1);
                
                updateChange('ordersChange', changes.orders);
                updateChange('unitsChange', changes.units);
                updateChange('customersChange', changes.customers);
                
                // Sparklines with Theme Colors
                createSparkline('ordersSparkline', [80, 85, 82, 90, 88, 95, 92, 100], '#3b82f6'); // Blue
                createSparkline('unitsSparkline', [70, 75, 78, 85, 82, 88, 90, 95], '#10b981');  // Emerald
                createSparkline('customersSparkline', [60, 65, 70, 68, 75, 80, 78, 85], '#f59e0b'); // Amber
                createSparkline('avgSparkline', [5, 5.2, 5.1, 5.3, 5.5, 5.4, 5.6, 5.8], '#8b5cf6'); // Violet
                
            } catch (error) {
                console.error(error);
            }
        }

        function updateChange(id, val) {
            const el = document.getElementById(id);
            const isPos = val >= 0;
            el.textContent = `${isPos ? '+' : ''}${val.toFixed(1)}%`;
            // Tailwind classes for badges
            el.className = `text-[10px] font-bold px-2 py-0.5 rounded-full ${isPos ? 'bg-emerald-100 text-emerald-700' : 'bg-rose-100 text-rose-700'}`;
            if(isPos) el.innerHTML = `<i class="fa-solid fa-arrow-up text-[8px] mr-1"></i>${val.toFixed(1)}%`;
            else el.innerHTML = `<i class="fa-solid fa-arrow-down text-[8px] mr-1"></i>${Math.abs(val).toFixed(1)}%`;
        }

        // 2. Sales Trend Chart
        async function loadSalesTrend() {
            try {
                const response = await fetch('/api/analytics/sales-trend?weeks=12');
                const data = await response.json();
                const ctx = document.getElementById('salesTrendChart');
                
                salesChart = new Chart(ctx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: data.data.map(d => new Date(d.week).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
                        datasets: [
                            {
                                label: 'Units Sold',
                                data: data.data.map(d => d.units),
                                borderColor: '#3b82f6', // Blue 500
                                backgroundColor: 'rgba(59, 130, 246, 0.05)',
                                tension: 0.4,
                                fill: true,
                                borderWidth: 2,
                                pointRadius: 0,
                                pointHoverRadius: 6
                            },
                            {
                                label: 'Orders',
                                data: data.data.map(d => d.orders),
                                borderColor: '#10b981', // Emerald 500
                                backgroundColor: 'rgba(16, 185, 129, 0.05)',
                                tension: 0.4,
                                fill: true,
                                borderWidth: 2,
                                pointRadius: 0,
                                pointHoverRadius: 6
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'top', align: 'end', labels: { usePointStyle: true, boxWidth: 8 } } },
                        scales: { y: { beginAtZero: true, grid: { borderDash: [4, 4] } }, x: { grid: { display: false } } },
                        interaction: { mode: 'index', intersect: false }
                    }
                });
            } catch (e) { console.error(e); }
        }

        // 3. Top Products Table
        async function loadTopProducts() {
            try {
                const response = await fetch('/api/analytics/top-products?limit=10');
                const data = await response.json();
                const tbody = document.getElementById('topProductsTable');
                tbody.innerHTML = '';
                
                if (!data.products.length) { tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center">No data</td></tr>'; return; }
                
                data.products.forEach((p, i) => {
                    // Badge Logic
                    let rankBadge = `bg-slate-100 text-slate-600`;
                    if(i===0) rankBadge = `bg-amber-100 text-amber-700 shadow-sm border border-amber-200`; // Gold
                    if(i===1) rankBadge = `bg-slate-200 text-slate-700 shadow-sm border border-slate-300`; // Silver
                    if(i===2) rankBadge = `bg-orange-100 text-orange-800 shadow-sm border border-orange-200`; // Bronze

                    const row = document.createElement('tr');
                    row.className = "hover:bg-slate-50 transition-colors border-b border-slate-50 last:border-0";
                    row.innerHTML = `
                        <td class="p-4 text-center"><span class="inline-flex h-6 w-6 items-center justify-center rounded-full text-xs font-bold ${rankBadge}">${i + 1}</span></td>
                        <td class="p-4 font-semibold text-slate-800">${p.product}</td>
                        <td class="p-4"><span class="px-2 py-1 rounded text-xs font-medium bg-slate-100 text-slate-600">${p.category}</span></td>
                        <td class="p-4 text-right font-bold text-slate-700">${p.units_sold.toLocaleString()}</td>
                        <td class="p-4 text-right text-slate-500">${p.orders.toLocaleString()}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (e) { console.error(e); }
        }

        // 4. Category Doughnut Chart
        async function loadCategoryBreakdown() {
            try {
                const response = await fetch('/api/analytics/category-breakdown');
                const data = await response.json();
                const ctx = document.getElementById('categoryChart');
                
                categoryChart = new Chart(ctx.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: data.categories.map(c => c.category),
                        datasets: [{
                            data: data.categories.map(c => c.units),
                            backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4'],
                            borderWidth: 0,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',
                        plugins: {
                            legend: { position: 'right', labels: { font: { size: 11 }, usePointStyle: true, boxWidth: 8 } }
                        }
                    }
                });
            } catch (e) { console.error(e); }
        }

        // 5. Territory Pie Chart
        async function loadTerritories() {
            try {
                const response = await fetch('/api/analytics/territory-performance?limit=10');
                const data = await response.json();
                const ctx = document.getElementById('territoryChart');
                
                territoryChart = new Chart(ctx.getContext('2d'), {
                    type: 'pie',
                    data: {
                        labels: data.territories.map(t => t.country),
                        datasets: [{
                            data: data.territories.map(t => t.units),
                            backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#ec4899'],
                            borderWidth: 0,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'right', labels: { font: { size: 11 }, usePointStyle: true, boxWidth: 8 } }
                        }
                    }
                });
            } catch (e) { console.error(e); }
        }
    </script>
</body>
</html>